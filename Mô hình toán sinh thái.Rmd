---
title: "Mô hình toán sinh thái"
author: "Trần Minh Anh"
date: "2024-12-02"
output: github_document
---

## 1. Mô phỏng mô hình SIR thông thường, mô hình A và mô hình B khi không có vacxin:

```{r}
#Tham số đầu vào: 
initial_values = c(S=999999, I=1, R=0, Total=1)
beta = 0.3
sigma = 0.1
parameters = c(beta, sigma)
# thời gian mô phỏng 
time1=seq(from=1, to=200, by=1)
```

**1a. Mô hình SIR cổ điển:**

```{r}
sir_model_classical <-function(time1,state,parameters){
  with(as.list(c(state,parameters)),{
  N=S+I+R
  F_conventional = beta*(I/N)
  dS = -F_conventional*S
  dI = F_conventional*S - sigma*I
  dR = sigma*I
  dTotal = F_conventional*S 
  
  return(list(c(dS,dI,dR,dTotal)))
  }
  )
}

#giải phương trình vi phân bằng hàm ode trong package deSolve 
library(deSolve)
SIR_model_classical = as.data.frame(ode(y = initial_values,
                                     func = sir_model_classical,
                                    parms = parameters,
                                    times = time1)) 
#Kết quả trả về sẽ là một data frame lưu trữ giá trị của S, I, R, và Total tại mỗi thời điểm từ 1 đến 200

# plot output Classical SIR model
N=1000000
#chuyển S, I, R thành tỉ lệ phần trăm so với N 
SIR_model_classical$S = 100*SIR_model_classical$S/N
SIR_model_classical$I = 100*SIR_model_classical$I/N
SIR_model_classical$R = 100*SIR_model_classical$R/N
SIR_model_classical$Total = 100*SIR_model_classical$Total/N

HIT = 100 * (1-sigma/beta)
HIT_time_SIR = which(SIR_model_classical$R > HIT)[1]

#Kết quả mô phỏng tại thời điểm dự đoán đạt HIT
print(SIR_model_classical[HIT_time_SIR, ])
#Kết quả tại thời điểm cuối mô phỏng 
print(SIR_model_classical[200, ])


SIR_long <- tidyr::pivot_longer(SIR_model_classical, 
                                cols = c(S, I, R, Total), 
                                names_to = "variable", 
                                values_to = "value")

# Vẽ biểu đồ sử dụng ggplot trong package ggplot2 
library(ggplot2)
ggplot(SIR_long, aes(x = time, y = value, color = variable)) +
  geom_line(size = 1.2) +
  scale_color_manual(values = c("S" = "blue", "I" = "red", "R" = "green", "Total" = "black")) +
  labs(x = "t", y = "Tổng dân số (%)", title = "Mô hình SIR cổ điển") +
  ylim(0, 100) +
  geom_hline(yintercept = HIT, linetype = "dashed") +
  annotate("text", x = 200, y = 10, label = "S(t)", size = 2) +
  annotate("text", x = 100, y = 20, label = "I(t)", size = 2) +
  annotate("text", x = 110, y = 80, label = "R(t)", size = 2) +
  annotate("text", x = 100, y = 100, label = "Tổng số ca nhiễm", size = 2) +
  annotate("text", x = 200, y = 70, label = "HIT", size = 2) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
    
    plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18)
  )

```

**1b. Mô hình A:**

```{r}
sir_model_A <-function(time1,state,parameters){
  with(as.list(c(state,parameters)),{
    N=S+I+R
    F_A = beta*(I/N)*(S/N)
    dS = -F_A*S
    dI = F_A*S - sigma*I
    dR = sigma*I
    dTotal = F_A*S 
    
    return(list(c(dS,dI,dR,dTotal)))
  }
  )
}


SIR_model_A = as.data.frame(ode(y =Initial_values,
                             func = sir_model_A,
                            parms = parameters,
                            times = time1))


N=1000000
SIR_model_A$S = 100*SIR_model_A$S/N
SIR_model_A$I = 100*SIR_model_A$I/N
SIR_model_A$R = 100*SIR_model_A$R/N
SIR_model_A$Total = 100*SIR_model_A$Total/N


HIT_time_A = which(SIR_model_A$R > HIT)[1]

print(SIR_model_A[HIT_time_A, ])
print(SIR_model_A[200, ])



SIR_A_long <- tidyr::pivot_longer(SIR_model_A, 
                                  cols = c(S, I, R, Total), 
                                  names_to = "variable", 
                                  values_to = "value")

# Vẽ biểu đồ
ggplot(SIR_A_long, aes(x = time, y = value, color = variable)) +
  geom_line(size = 1.2) +
  scale_color_manual(values = c("S" = "blue", "I" = "red", "R" = "green", "Total" = "black")) +
  labs(x = "t", y = "Tổng dân số (%)", title = "Mô hình A") +
  ylim(0, 100) +
  geom_hline(yintercept = HIT, linetype = "dashed") +
  annotate("text", x = 200, y = 40, label = "S(t)", size = 2) +
  annotate("text", x = 100, y = 15, label = "I(t)", size = 2) +
  annotate("text", x = 110, y = 50, label = "R(t)", size = 2) +
  annotate("text", x = 150, y = 70, label = "Tổng số ca nhiễm", size = 2) +
  annotate("text", x = 5, y = 70, label = "HIT", size = 2) +
  theme_minimal()+
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
        plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18))
```

**1c. Mô hình B:**

```{r}
sir_model_B <-function(time1,state,parameters){
  with(as.list(c(state,parameters)),{
    N=S+I+R
    F_B = beta*(I/N)*((N-R)/N)
    dS = -F_B*S
    dI = F_B*S - sigma*I
    dR = sigma*I
    dTotal = F_B*S 
    
    return(list(c(dS,dI,dR,dTotal)))
  }
  )
}


SIR_model_B = as.data.frame(ode(y = Initial_values,
                             func = sir_model_B,
                            parms = parameters,
                            times = time1)) 


N=1000000
SIR_model_B$S = 100*SIR_model_B$S/N
SIR_model_B$I = 100*SIR_model_B$I/N
SIR_model_B$R = 100*SIR_model_B$R/N
SIR_model_B$Total = 100*SIR_model_B$Total/N

HIT_time_B = which(SIR_model_B$R > HIT)[1]
print(SIR_model_B[HIT_time_B,])
print(SIR_model_B[200,])

SIR_B_long <- tidyr::pivot_longer(SIR_model_B, 
                                  cols = c(S, I, R, Total), 
                                  names_to = "variable", 
                                  values_to = "value")

# Vẽ biểu đồ
ggplot(SIR_B_long, aes(x = time, y = value, color = variable)) +
  geom_line(size = 1.2) +  
  scale_color_manual(values = c("S" = "blue", "I" = "red", "R" = "green", "Total" = "black")) +
  labs(x = "t", y = "Tổng dân số (%)", title = "Mô hình B") +
  ylim(0, 100) +
  geom_hline(yintercept = HIT, linetype = "dashed") +
  annotate("text", x = 200, y = 30, label = "S(t)", size = 2) +
  annotate("text", x = 90, y = 20, label = "I(t)", size = 2) +
  annotate("text", x = 100, y = 60, label = "R(t)", size = 2) +
  annotate("text", x = 150, y = 80, label = "Tổng số ca nhiễm", size = 2) +
  annotate("text", x = 200, y = 70, label = "HIT", size = 2) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
        plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18))

```

**1d. Phân tích độ nhạy của các mô hình khi thay đổi giá trị r0:**

```{r}
#Các giá trị R0 
beta = seq(from=0.11, to=1.0, by=0.01)
r0 = beta/0.1 #sigma = 0.1 r0 = beta/sigma
reproduction = as.data.frame(r0)
#Tính ngưỡng HIT cho từng giá trị R0 
reproduction$HIT = 100*(1-(1/reproduction$r0))
```

```{r}
# Phân tích độ nhạy với mô hình SIR cổ điển 
dat_classical = data.frame()

#Tạo các mô hình với các giá trị R0 thay đổi 
for(beta in seq(from=0.11, to=1.0, by=0.01)){
  
  Initial_values = c(S=999999, I=1, R=0, Total=1)
  parameters = c(beta, sigma=0.1)
  
  # time
  time=seq(from=1, to=1000, by=1)
  
  sir_model_classical <-function(time,state,parameters){
    with(as.list(c(state,parameters)),{
      N=S+I+R
      F_conventional = beta*(I/N)
      dS = -F_conventional*S
      dI = F_conventional*S - sigma*I
      dR = sigma*I
      dTotal = F_conventional*S 
      
      return(list(c(dS,dI,dR,dTotal)))
    }
    )
  }
  
  #Giải phương trình vi phân 
  SIR_model_classical = as.data.frame(ode(y = Initial_values,
                                       func = sir_model_classical,
                                      parms = parameters,
                                      times = time)) 
    
   
  classical = (SIR_model_classical[1000,]) 
  #Tại mỗi bước của vòng lặp, giá trị tại thời điểm thứ 1000 (giá trị cuối cùng của   mô phỏng) được lưu vào biến classical
  dat_classical = rbind(dat_classical, classical)

}
#Chuyển đổi tổng số ca nhiễm (Total) thành tỷ lệ phần trăm của dân số
dat_classical$Total = dat_classical$Total*100/N
plot(reproduction$r0,dat_classical$Total,type = "l",
     ylim = c(0,100),col="blue", xlab = "Hệ số lây nhiễm(r0)", ylab = "Tổng số ca nhiễm(%)")
lines(reproduction$r0, reproduction$HIT,type = "b")
```

```{r}
# Phân tích độ nhạy với mô hình A 

dat_A = data.frame()

for(beta in seq(from=0.11, to=1.0, by=0.01)){
  
  Initial_values = c(S=999999, I=1, R=0, Total=1)
  parameters = c(beta, sigma=0.1)
  
  # time
  time=seq(from=1, to=1000, by=1)
  
  
  sir_model_A <-function(time,state,parameters){
    with(as.list(c(state,parameters)),{
      N=S+I+R
      F_A = beta*(I/N)*(S/N)
      dS = -F_A*S
      dI = F_A*S - sigma*I
      dR = sigma*I
      dTotal = F_A*S 
      
      return(list(c(dS,dI,dR,dTotal)))
    }
    )
  }
  
  SIR_model_A = as.data.frame(ode(y = Initial_values,
                               func = sir_model_A,
                              parms = parameters,
                              times = time)) 
  
  
  Model_A = (SIR_model_A[1000,]) 
  dat_A = rbind(dat_A, Model_A)
  
}

dat_A$Total = dat_A$Total*100/N
plot(reproduction$r0,dat_A$Total,type = "l",
     ylim = c(0,100),col="red", xlab = "Hệ số lây nhiễm(r0)", ylab = "Tổng số ca nhiễm(%)")
lines(reproduction$r0, reproduction$HIT,type = "b")
```

```{r}
# Phân tích độ nhạy với mô hình B 

dat_B = data.frame()

for(beta in seq(from=0.11, to=1.0, by=0.01)){
  
  Initial_values = c(S=999999, I=1, R=0, Total=1)
  parameters = c(beta, sigma=0.1)
  
  # time
  time=seq(from=1, to=1000, by=1)
  
  
  sir_model_B <-function(time,state,parameters){
    with(as.list(c(state,parameters)),{
      N=S+I+R
      F_B = beta*(I/N)*((N-R)/N)
      dS = -F_B*S
      dI = F_B*S - sigma*I
      dR = sigma*I
      dTotal = F_B*S 
      
      return(list(c(dS,dI,dR,dTotal)))
    }
    )
  }
  
  SIR_model_B = as.data.frame(ode(y = Initial_values,
                               func = sir_model_B,
                              parms = parameters,
                              times = time)) 
  
  
  Model_B = (SIR_model_B[1000,]) 
  dat_B = rbind(dat_B, Model_B)
  
}

dat_B$Total = dat_B$Total*100/N
plot(reproduction$r0,dat_B$Total,type = "l", col="green", xlab = "Hệ số lây nhiễm(r0)", ylab = "Tổng số ca nhiễm(%)")
lines(reproduction$r0, reproduction$HIT,type = "b")
```

```{r}
# Kết hợp kết quả ba mô hình SIR cổ điển, mô hình A, mô hình B 

combined_data <- data.frame(
  r0 = reproduction$r0,
  SIR_cổ_điển = dat_classical$Total,
  Mô_hình_A = dat_A$Total,
  Mô_hình_B = dat_B$Total,
  HIT = reproduction$HIT
)

# Chuyển dữ liệu sang dạng long để dễ vẽ với ggplot2
long_data <- tidyr::pivot_longer(combined_data, 
                                 cols = c(SIR_cổ_điển, Mô_hình_A, Mô_hình_B, HIT), 
                                 names_to = "variable", 
                                 values_to = "value")

# Vẽ biểu đồ
ggplot(long_data, aes(x = r0, y = value, color = variable)) +
  geom_line(data = subset(long_data, variable != "HIT"), size = 1.5) + 
  geom_point(data = subset(long_data, variable == "HIT"), size = 1) +  
  scale_color_manual(values = c("SIR_cổ_điển" = "blue", "Mô_hình_A" = "green", "Mô_hình_B" = "red", "HIT" = "black")) +
  labs(x = "Hệ số sinh sản cơ bản (r0)", y = "Tổng số ca nhiễm bệnh (%)", 
       title = "Tổng số ca nhiễm khi thay đổi giá trị R0") +
  ylim(0, 100) +
  annotate("text", x = 2.5, y = 100, label = "SIR cổ điển", size = 3) +
  annotate("text", x = 2.8, y = 82, label = "Mô hình B", size = 3) +
  annotate("text", x = 6.0, y = 70, label = "Mô hình A, HIT", size = 3) +
  theme_minimal()+
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
        plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18))
```

## 2. Mô phỏng mô hình SIR thông thường, mô hình A và mô hình B khi tỉ lệ vacxin cao (v = 1.0%)

**2a. Mô hình SIR thông thường**

```{r}
Initial_values = c(S=989999, I=1, R=10000, V=10000, Total=1)
parameters = c(beta=0.3, sigma=0.1, v=10000, time_threshold=67)

time = seq(from=1, to=500, by=1)

vm_classical <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    # Điều chỉnh tỷ lệ tiêm vaccine dựa trên thời gian
    current_v = if (time <= time_threshold) v else 0
    
    N = S + I + R
    F_conventional = beta * (I / N)
    dS = -F_conventional * S - current_v
    dI = F_conventional * S - sigma * I
    dR = sigma * I + current_v
    dV = current_v
    dTotal = F_conventional * S
    
    return(list(c(dS, dI, dR, dV, dTotal)))
  })
}

# Giải phương trình vi phân
VM_classical = as.data.frame(ode(
  y = Initial_values,
  func = vm_classical,
  parms = parameters,
  times = time
))


N=1000000
VM_classical$Total = 100*VM_classical$Total/N
VM_classical$S = 100*VM_classical$S/N
VM_classical$I = 100*VM_classical$I/N
VM_classical$R = 100*VM_classical$R/N
VM_classical$V = 100*VM_classical$V/N

print(VM_classical[67,])
print(VM_classical[500,])


#Vé biểu đồ bằng ggplot 
ggplot(VM_classical, aes(x = time, y = Total)) +
  geom_line(color = "blue", size = 1) +  # Đường biểu diễn tổng số ca nhiễm
  geom_vline(xintercept = HIT_time, linetype = "dashed", size = 1) +  # Đường thẳng đứng tại t = 67
  labs(x = "t", y = "Tổng số ca nhiễm (%)", title = "SIR cổ điển (v=1.0%)") +
  ylim(0, 2.0) +
  annotate("text", x = 85, y = 2.0, label = "HIT đạt tại t=67", size = 4, hjust = 0) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
        plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18))

```

**2b. Mô hình A**

```{r}

Initial_values = c(S = 989999, I = 1, R = 10000, V = 10000, Total = 1)
parameters = c(beta = 0.3, sigma = 0.1, v = 10000, time_threshold = 67)


time = seq(from = 1, to = 500, by = 1)

vm_model_A <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    # Điều chỉnh tỷ lệ tiêm vaccine khi đạt HIT 
    current_v = if (time <= time_threshold) v else 0
    
    N = S + I + R
    F_A = beta * (I / N) * (S / N)
    dS = -F_A * S - current_v
    dI = F_A * S - sigma * I
    dR = sigma * I + current_v
    dV = current_v
    dTotal = F_A * S
    
    return(list(c(dS, dI, dR, dV, dTotal)))
  })
}

# Giải phương trình vi phân
VM_A = as.data.frame(ode(
  y = Initial_values,
  func = vm_model_A,
  parms = parameters,
  times = time
))


N=1000000
VM_A$Total = 100*VM_A$Total/N
VM_A$S = 100*VM_A$S/N
VM_A$I = 100*VM_A$I/N
VM_A$R = 100*VM_A$R/N
VM_A$V = 100*VM_A$V/N

print(VM_A[67,])
print(VM_A[500,])


#Vẽ biểu đồ bằng ggplot 
ggplot(VM_A, aes(x = time, y = Total)) +
  geom_line(color = "blue", size = 1) +  # Đường biểu diễn tổng số ca nhiễm
  geom_vline(xintercept = 67, linetype = "dashed", size = 1) +  # Đường thẳng đứng tại t = 67
  labs(x = "t", y = "Tổng số ca nhiễm (%)", title = "Mô hình A (v=1.0%)") +
  ylim(0, 0.1) +
  annotate("text", x = 85, y = 0.1, label = "HIT đạt tại t=67", size = 4, hjust = 0) +
  theme_minimal()+
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
        plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18))

```

**2c. Mô hình B**

```{r}
Initial_values = c(S=989999, I=1, R=10000, V=10000, Total=1)
parameters = c(beta=0.3, sigma=0.1, v=10000, time_threshold = 67)

time=seq(from=1, to=500, by=1)

vm_model_B <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    # Điều chỉnh tỷ lệ tiêm vaccine khi đạt HIT 
    current_v = if (time <= time_threshold) v else 0
    
    N = S + I + R
    F_B = beta*(I/N)*((N-R)/N)
    dS = -F_B * S - current_v
    dI = F_B * S - sigma * I
    dR = sigma * I + current_v
    dV = current_v
    dTotal = F_B * S
    
    return(list(c(dS, dI, dR, dV, dTotal)))
  })
}

# Giải phương trình vi phân
VM_B = as.data.frame(ode(
  y = Initial_values,
  func = vm_model_B,
  parms = parameters,
  times = time
))

N=1000000
VM_B$Total = 100*VM_B$Total/N
VM_B$S = 100*VM_B$S/N
VM_B$I = 100*VM_B$I/N
VM_B$R = 100*VM_B$R/N
VM_B$V = 100*VM_B$V/N

print(VM_B[67,])
print(VM_B[500,])

#Vé biểu đồ bằng ggplot 
ggplot(VM_B, aes(x = time, y = Total)) +
  geom_line(color = "blue", size = 1) +  # Đường biểu diễn tổng số ca nhiễm
  geom_vline(xintercept = 67, linetype = "dashed", size = 1) +  # Đường thẳng đứng tại t = 67
  labs(x = "t", y = "Tổng số ca nhiễm (%)", title = "Mô hình B (v=1.0%)") +
  ylim(0, 0.1) +
  annotate("text", x = 85, y = 0.1, label = "HIT đạt tại t=67", size = 4, hjust = 0) +
  theme_minimal()+
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
        plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18))
```

## 3. Mô phỏng mô hình SIR thông thường, mô hình A và mô hình B khi tỉ lệ vacxin trung bình (v = 0.5%)

**3a. Mô hình SIR thông thường**

```{r}
Initial_values = c(S=994999, I=1, R=5000, V=5000, Total=1)
parameters = c(beta=0.3, sigma=0.1, v=5000, time_threshold=100)

time = seq(from=1, to=300, by=1)

vm2_classical <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    # Điều chỉnh tỷ lệ tiêm vaccine dựa trên thời gian
    current_v = if (time <= time_threshold) v else 0
    
    N = S + I + R
    F_conventional = beta * (I / N)
    dS = -F_conventional * S - current_v
    dI = F_conventional * S - sigma * I
    dR = sigma * I + current_v
    dV = current_v
    dTotal = F_conventional * S
    
    return(list(c(dS, dI, dR, dV, dTotal)))
  })
}

# Giải phương trình vi phân
VM2_classical = as.data.frame(ode(
  y = Initial_values,
  func = vm_classical,
  parms = parameters,
  times = time
))



# plot output Conventional SIR vaccine model
N=1000000
VM2_classical$Total = 100*VM2_classical$Total/N
VM2_classical$S = 100*VM2_classical$S/N
VM2_classical$I = 100*VM2_classical$I/N
VM2_classical$R = 100*VM2_classical$R/N
VM2_classical$V = 100*VM2_classical$V/N

print(VM2_classical[100,])
print(VM2_classical[300,])

#Vé biểu đồ bằng ggplot 
ggplot(VM2_classical, aes(x = time, y = Total)) +
  geom_line(color = "blue", size = 1) +  # Đường biểu diễn tổng số ca nhiễm
  geom_vline(xintercept = 100, linetype = "dashed", size = 1) +  # Đường thẳng đứng tại t = 67
  labs(x = "t", y = "Tổng số ca nhiễm (%)", title = "SIR cổ điển (v=0.5%)") +
  ylim(0, 50.0) +
  annotate("text", x = 85, y = 50, label = "HIT đạt tại t=100", size = 4, hjust = 0) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
        plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18))
```

**3b. Mô hình A**

```{r}

Initial_values = c(S=994999, I=1, R=5000, V=5000, Total=1)
parameters = c(beta=0.3, sigma=0.1, v=5000, time_threshold = 131)


time = seq(from = 1, to = 300, by = 1)

vm2_model_A <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    # Điều chỉnh tỷ lệ tiêm vaccine khi đạt HIT 
    current_v = if (time <= time_threshold) v else 0
    
    N = S + I + R
    F_A = beta * (I / N) * (S / N)
    dS = -F_A * S - current_v
    dI = F_A * S - sigma * I
    dR = sigma * I + current_v
    dV = current_v
    dTotal = F_A * S
    
    return(list(c(dS, dI, dR, dV, dTotal)))
  })
}

# Giải phương trình vi phân
VM2_A = as.data.frame(ode(
  y = Initial_values,
  func = vm2_model_A,
  parms = parameters,
  times = time
))


N=1000000
VM2_A$Total = 100*VM2_A$Total/N
VM2_A$S = 100*VM2_A$S/N
VM2_A$I = 100*VM2_A$I/N
VM2_A$R = 100*VM2_A$R/N
VM2_A$V = 100*VM2_A$V/N

print(VM2_A[131,])
print(VM2_A[300,])


#Vé biểu đồ bằng ggplot 
ggplot(VM2_A, aes(x = time, y = Total)) +
  geom_line(color = "blue", size = 1) +  # Đường biểu diễn tổng số ca nhiễm
  geom_vline(xintercept = 131, linetype = "dashed", size = 1) +  # Đường thẳng đứng tại t = 67
  labs(x = "t", y = "Tổng số ca nhiễm (%)", title = "Mô hình A (v=0.5%)") +
  ylim(0, 5.00) +
  annotate("text", x = 135, y = 5.0, label = "HIT đạt tại t=131", size = 4, hjust = 0) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
        plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18))
```

**3c. Mô hình B**

```{r}
Initial_values = c(S=994999, I=1, R=5000,V=5000, Total=1)
parameters = c(beta=0.3, sigma=0.1, v=5000, time_threshold = 131)

time = seq(from = 1, to = 300, by = 1)

vm2_model_B <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    # Điều chỉnh tỷ lệ tiêm vaccine khi đạt HIT 
    current_v = if (time <= time_threshold) v else 0
    
    N = S + I + R
    F_B = beta*(I/N)*((N-R)/N)
    dS = -F_B * S - current_v
    dI = F_B * S - sigma * I
    dR = sigma * I + current_v
    dV = current_v
    dTotal = F_B * S
    
    return(list(c(dS, dI, dR, dV, dTotal)))
  })
}

# Giải phương trình vi phân
VM2_B = as.data.frame(ode(
  y = Initial_values,
  func = vm2_model_B,
  parms = parameters,
  times = time
))

N=1000000
VM2_B$Total = 100*VM2_B$Total/N
VM2_B$S = 100*VM2_B$S/N
VM2_B$I = 100*VM2_B$I/N
VM2_B$R = 100*VM2_B$R/N
VM2_B$V = 100*VM2_B$V/N

print(VM2_B[131,])
print(VM2_B[300,])


#Vé biểu đồ bằng ggplot 
ggplot(VM2_B, aes(x = time, y = Total)) +
  geom_line(color = "blue", size = 1) +  # Đường biểu diễn tổng số ca nhiễm
  geom_vline(xintercept = 131, linetype = "dashed", size = 1) +  # Đường thẳng đứng tại t = 67
  labs(x = "t", y = "Tổng số ca nhiễm (%)", title = "Mô hình B (v=0.5%)") +
  ylim(0, 5.0) +
  annotate("text", x = 135, y = 5.0, label = "HIT đạt tại t=131", size = 4, hjust = 0) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
        plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18))
```

## 3. Mô phỏng mô hình SIR thông thường, mô hình A và mô hình B khi tỉ lệ vacxin thấp (v = 0.1%)

**3a. Mô hình SIR thông thường**

```{r}
Initial_values = c(S=998999, I=1, R=1000, V=1000, Total=1)
parameters = c(beta=0.3, sigma=0.1, v=1000, time_threshold=87)

time = seq(from=1, to=200, by=1)

vm3_classical <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    # Điều chỉnh tỷ lệ tiêm vaccine dựa trên thời gian
    current_v = if (time <= time_threshold) v else 0
    
    N = S + I + R
    F_conventional = beta * (I / N)
    dS = -F_conventional * S - current_v
    dI = F_conventional * S - sigma * I
    dR = sigma * I + current_v
    dV = current_v
    dTotal = F_conventional * S
    
    return(list(c(dS, dI, dR, dV, dTotal)))
  })
}

# Giải phương trình vi phân
VM3_classical = as.data.frame(ode(
  y = Initial_values,
  func = vm3_classical,
  parms = parameters,
  times = time
))


N=1000000
VM3_classical$Total = 100*VM3_classical$Total/N
VM3_classical$S = 100*VM3_classical$S/N
VM3_classical$I = 100*VM3_classical$I/N
VM3_classical$R = 100*VM3_classical$R/N
VM3_classical$V = 100*VM3_classical$V/N

print(VM3_classical[87,])
print(VM3_classical[200,])

#Vé biểu đồ bằng ggplot 
ggplot(VM3_classical, aes(x = time, y = Total)) +
  geom_line(color = "blue", size = 1) +  # Đường biểu diễn tổng số ca nhiễm
  geom_vline(xintercept = 87, linetype = "dashed", size = 1) +  # Đường thẳng đứng tại t = 67
  labs(x = "t", y = "Tổng số ca nhiễm (%)", title = "SIR cổ điển (v=0.1%)") +
  ylim(0, 100.0) +
  annotate("text", x = 90, y = 100, label = "HIT đạt tại t=87", size = 4, hjust = 0) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
        plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18))
```

**3b. Mô hình A**

```{r}
Initial_values = c(S=998999, I=1, R=1000,V=1000, Total=1)
parameters = c(beta=0.3, sigma=0.1, v=1000, time_threshold = 134)


time = seq(from = 1, to = 200, by = 1)

vm3_model_A <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    # Điều chỉnh tỷ lệ tiêm vaccine khi đạt HIT 
    current_v = if (time <= time_threshold) v else 0
    
    N = S + I + R
    F_A = beta * (I / N) * (S / N)
    dS = -F_A * S - current_v
    dI = F_A * S - sigma * I
    dR = sigma * I + current_v
    dV = current_v
    dTotal = F_A * S
    
    return(list(c(dS, dI, dR, dV, dTotal)))
  })
}

# Giải phương trình vi phân
VM3_A = as.data.frame(ode(
  y = Initial_values,
  func = vm3_model_A,
  parms = parameters,
  times = time
))

# plot output SIR vaccine model A
N=1000000
VM3_A$Total = 100*VM3_A$Total/N
VM3_A$S = 100*VM3_A$S/N
VM3_A$I = 100*VM3_A$I/N
VM3_A$R = 100*VM3_A$R/N
VM3_A$V = 100*VM3_A$V/N

print(VM3_A[134,])
print(VM3_A[200,])

#Vé biểu đồ bằng ggplot 
ggplot(VM3_A, aes(x = time, y = Total)) +
  geom_line(color = "blue", size = 1) +  # Đường biểu diễn tổng số ca nhiễm
  geom_vline(xintercept = 134, linetype = "dashed", size = 1) +  # Đường thẳng đứng tại t = 67
  labs(x = "t", y = "Tổng số ca nhiễm (%)", title = "Mô hình A (v=0.1%)") +
  ylim(0, 100) +
  annotate("text", x = 130, y = 100, label = "HIT đạt tại t=134", size = 4, hjust = 0) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
        plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18))
```

**3c. Mô hình B**

```{r}
Initial_values = c(S=998999, I=1, R=1000, V=1000, Total=1)
parameters = c(beta=0.3, sigma=0.1, v=1000, time_threshold = 107)

time = seq(from = 1, to = 200, by = 1)

vm3_model_B <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    # Điều chỉnh tỷ lệ tiêm vaccine khi đạt HIT 
    current_v = if (time <= time_threshold) v else 0
    
    N = S + I + R
    F_B = beta*(I/N)*((N-R)/N)
    dS = -F_B * S - current_v
    dI = F_B * S - sigma * I
    dR = sigma * I + current_v
    dV = current_v
    dTotal = F_B * S
    
    return(list(c(dS, dI, dR, dV, dTotal)))
  })
}

# Giải phương trình vi phân
VM3_B = as.data.frame(ode(
  y = Initial_values,
  func = vm3_model_B,
  parms = parameters,
  times = time
))


# plot output SIR vaccine model B
N=1000000
VM3_B$Total = 100*VM3_B$Total/N
VM3_B$S = 100*VM3_B$S/N
VM3_B$I = 100*VM3_B$I/N
VM3_B$R = 100*VM3_B$R/N
VM3_B$V = 100*VM3_B$V/N

print(VM3_B[107,])
print(VM3_B[200,])

#Vé biểu đồ bằng ggplot 
ggplot(VM3_B, aes(x = time, y = Total)) +
  geom_line(color = "blue", size = 1) +  # Đường biểu diễn tổng số ca nhiễm
  geom_vline(xintercept = 107, linetype = "dashed", size = 1) +  # Đường thẳng đứng tại t = 67
  labs(x = "t", y = "Tổng số ca nhiễm (%)", title = "Mô hình B (v=0.1%)") +
  ylim(0, 100.0) +
  annotate("text", x = 100, y = 100, label = "HIT đạt tại t=107", size = 4, hjust = 0) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "lightgray", color = NA),
        plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18))
```

## 4. Mô phỏng dịch cúm mùa ở Mỹ:

**\*Giải thích các phương trình:**

1\. **Tổng số dân: N = S + I + R + V1 + V2**

Đây là phương trình tính **tổng số dân**, trong đó:

-   `S`: Số người nhạy cảm (có khả năng bị nhiễm bệnh).

-   `I`: Số người bị nhiễm bệnh.

-   `R`: Số người đã hồi phục (và có miễn dịch).

-   `V1`: Số người đã được tiêm vắc-xin nhưng chưa phát triển miễn dịch đầy đủ.

-   `V2`: Số người đã được tiêm vắc-xin và đã phát triển miễn dịch đầy đủ.

2\. **Tỷ lệ lây nhiễm từ nhóm chưa tiêm phòng: F_conventional = beta \* (I / N)**

Phương trình này tính tỷ lệ lây nhiễm trong nhóm chưa tiêm phòng, được xác định bởi:

-   `beta`: Tỷ lệ lây nhiễm (khả năng lây bệnh từ người nhiễm sang người nhạy cảm).

-   `(I / N)`: Phần trăm người bị nhiễm bệnh trong tổng số dân. Khi số người bị nhiễm tăng, khả năng lây nhiễm tăng.

3\. **Tỷ lệ lây nhiễm từ nhóm đã tiêm phòng: F_V = rr \* F_conventional**

Đây là tỷ lệ lây nhiễm từ nhóm đã tiêm vắc-xin.

-   `rr`: Hệ số giảm tỷ lệ lây nhiễm từ nhóm tiêm phòng so với nhóm không tiêm phòng. Ví dụ, nếu `rr = 0.5`, người đã tiêm phòng có 50% khả năng bị nhiễm so với người chưa tiêm phòng.

-   `F_conventional`: Tỷ lệ lây nhiễm từ nhóm chưa tiêm phòng. Nhóm đã tiêm phòng vẫn có thể bị nhiễm, nhưng với tỷ lệ thấp hơn (`rr`).

4\. **Phương trình thay đổi số người nhạy cảm (dS): dS = -F_conventional \* S + w \* R + b \* N + w \* V2 - v \* N**

-   **Giảm**:

    -   `-F_conventional * S`: Số người nhạy cảm bị nhiễm bệnh (do tiếp xúc với người bị nhiễm).

    -   `-v * N`: Số người nhạy cảm được tiêm vắc-xin (họ sẽ chuyển sang nhóm đã tiêm phòng).

-   **Tăng**:

    -   `w * R`: Số người đã hồi phục và mất đi miễn dịch, trở lại nhóm nhạy cảm.

    -   `w * V2`: Số người đã tiêm phòng và mất đi miễn dịch, trở lại nhóm nhạy cảm.

    -   `b * N`: Số người mới sinh ra hoặc nhập cư vào dân số, mặc định là người nhạy cảm.

5\. **Phương trình thay đổi số người nhiễm bệnh (dI): dI = F_conventional \* S + F_conventional \* V1 + F_V \* V2 - sigma \* I**

-   **Tăng**:

    -   `F_conventional * S`: Số người nhạy cảm bị nhiễm bệnh.

    -   `F_conventional * V1`: Số người đã tiêm phòng (nhưng chưa có miễn dịch đầy đủ) bị nhiễm bệnh.

    -   `F_V * V2`: Số người đã tiêm phòng và có miễn dịch bị nhiễm bệnh (tỷ lệ thấp hơn do hệ số `rr`).

-   **Giảm**:

    -   `-sigma * I`: Số người nhiễm bệnh đã hồi phục và chuyển sang nhóm `R`.

6\. **Phương trình thay đổi số người hồi phục (dR): dR = sigma \* I - w \* R**

-   **Tăng**:

    -   `sigma * I`: Số người nhiễm bệnh đã hồi phục và có miễn dịch.

-   **Giảm**:

    -   `-w * R`: Số người hồi phục và mất miễn dịch (do thời gian miễn dịch kết thúc), họ quay lại nhóm nhạy cảm `S`.

7\. **Phương trình thay đổi tổng số ca nhiễm tích lũy (dItotal): dItotal = F_conventional \* S + F_conventional \* V1 + F_V \* V2**

Đây là phương trình tính **tổng số ca nhiễm tích lũy**. Nó tính tổng số ca nhiễm mới từ tất cả các nhóm:

-   Nhóm nhạy cảm `S`.

-   Nhóm tiêm phòng chưa có miễn dịch `V1`.

-   Nhóm tiêm phòng có miễn dịch `V2`.

8\. **Phương trình thay đổi số người tiêm phòng nhưng chưa có miễn dịch đầy đủ (dV1): dV1 = v \* N - F_conventional \* V1 - gamma \* V1**

-   **Tăng**:

    -   `v * N`: Số người được tiêm vắc-xin.

-   **Giảm**:

    -   `-F_conventional * V1`: Số người tiêm phòng nhưng chưa có miễn dịch bị nhiễm bệnh.

    -   `-gamma * V1`: Số người tiêm phòng đã phát triển miễn dịch đầy đủ và chuyển sang nhóm `V2`.

9\. **Phương trình thay đổi số người tiêm phòng và có miễn dịch đầy đủ (dV2): dV2 = gamma \* V1 - F_V \* V2 - w \* V2**

-   **Tăng**:

    -   `gamma * V1`: Số người tiêm phòng phát triển miễn dịch đầy đủ và chuyển sang nhóm `V2`.

-   **Giảm**:

    -   `-F_V * V2`: Số người trong nhóm đã có miễn dịch bị nhiễm bệnh (tỷ lệ thấp hơn so với nhóm `S` do có `rr`).

    -   `-w * V2`: Số người mất đi miễn dịch (sau khi đã tiêm phòng) và quay lại nhóm nhạy cảm `S`.

**4a. Mô hình SIR thông thường:**

```{r}
rm(list=ls())

Initial_values = c(S=295000000, I=1, R=0, Itotal=1, V1=0,V2=0)
parameters = c(beta=0.3, sigma=0.2, Dur = 180, Dur2 = 14,
               b=3/146000, v=0.0010958, rr=0.5)

#Thời gian trong 19 năm 
time = seq(from = 1, to = 6935, by = 1) 


sir_model_classical <-function(time,state,parameters){
  with(as.list(c(state,parameters)),{
    N=S+I+R+V1+V2
    F_conventional = beta*(I/N)
    F_V = rr*F_conventional
    w = 1/Dur
    gamma = 1/Dur2
    dS = -F_conventional*S + w*R + b*N +w*V2 - v*N
    dI = F_conventional*S + F_conventional*V1 + F_V*V2 - sigma*I
    dR = sigma*I - w*R
    dItotal = F_conventional*S + F_conventional*V1 + F_V*V2
    dV1 = v*N - F_conventional*V1 - gamma*V1
    dV2 = gamma*V1 - F_V*V2 - w*V2
    
    return(list(c(dS,dI,dR,dItotal,dV1,dV2)))
  }
  )
}

library(deSolve)

SIR_model_classical = as.data.frame(ode(y = Initial_values,
                                        func = sir_model_classical,
                                        parms = parameters,
                                        times = time)) 


attach(SIR_model_classical)
N = S + I + R + V1 + V2
N_per = 100 * N / N
S_per = 100 * S / N
I_per = 100 * I / N
R_per = 100 * R / N
V1_per = 100 * V1 / N
V2_per = 100 * V2 / N
Itotal_per = 100 * Itotal / N

SIR_model_classical = cbind(SIR_model_classical, N, N_per, S_per, I_per, R_per, V1_per, V2_per, Itotal_per)


plot(time,
     I_per,type = "l", col="red",
     ylab = "Tổng dân số(%)", ylim = c(0,100),
     xlab = "t", xlim=c(0,6000), , lwd = 2)
lines(time, N_per)
lines(time, V2_per, col="darkorange", lwd = 2)
lines(time, S_per, col="blue", lwd = 2)
lines(time, R_per, col="darkgreen", lwd = 2)
abline(v=1826, lwd = 2, type = "dashed")
text(x=1900, y=80, "Thời điểm đạt trạng thái cân bằng t=1826",cex=0.8, adj=0)
title("A) Mô hình SIR cổ điển", cex=0.8, adj=0)
# Thêm legend
legend("topright", legend=c("I", "V2", "S", "R"),
       col=c("red", "darkorange", "blue", "darkgreen"), lwd=2, cex=0.8)

#ggplot
long_data <- tidyr::pivot_longer(SIR_model_classical, 
                                 cols = c(I_per, V2_per, S_per, R_per), 
                                 names_to = "variable", 
                                 values_to = "value")
long_data <- na.omit(long_data)

long_data <- long_data[long_data$value >= 0 & long_data$value <= 100 & long_data$time >= 0 & long_data$time <= 6000, ]
library(ggplot2)
# Vẽ biểu đồ
ggplot(long_data, aes(x = time, y = value, color = variable)) +
  geom_line(size = 1) +
  geom_vline(xintercept = 1826, linetype = "dashed", size = 1) +  # Đường thẳng đứng tại t = 1826
  annotate("text", x = 1900, y = 80, label = "Thời điểm đạt trạng thái cân bằng t=1826", size = 3, hjust = 0) +
  scale_color_manual(values = c("I_per" = "red", "V2_per" = "darkorange", "S_per" = "blue", "R_per" = "darkgreen"),
                     labels = c("I(t)", "R(t)", "S(t)", "V2(t)")) +  # Đặt tên cho các nhãn chú thích
  labs(x = "t", y = "Tổng dân số (%)", title = "Mô hình SIR cổ điển") +
  ylim(0, 100) +
  xlim(0, 6000) +
  theme_minimal() +
  theme(
    legend.position = c(0.8, 0.8),  # Đặt vị trí của legend
    legend.background = element_rect(fill = "white", color = "black", size = 0.5, linetype = "solid"),  # Tạo khung cho legend
    panel.background = element_rect(fill = "lightgray", color = NA),plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18) 
  ) +
  guides(color = guide_legend(title = NULL, override.aes = list(lwd = 2)))  # Thiết lập độ dày của các đường trong legend

#Tạo vecto cho thời điểm cuối các năm 
years <- seq(365, 6935, by = 365)


# Tạo dữ liệu cho các năm (Year1, Year2,...)
burden_classicalSIR_V_cases <- list()
burden_classicalSIR_V_per <- list()
for (i in seq_along(years)) {
  start_idx <- ifelse(i == 1, 1, years[i-1] + 1)
  end_idx <- years[i]
  
  burden_classicalSIR_V_cases[[i]] <- SIR_model_classical$Itotal[start_idx:end_idx] - ifelse(i == 1, 0, SIR_model_classical$Itotal[years[i - 1]])
  burden_classicalSIR_V_per[[i]] <- SIR_model_classical$Itotal_per[start_idx:end_idx] - ifelse(i == 1, 0, SIR_model_classical$Itotal_per[years[i-1]])
}

#Chuyển từ list sang dataframe
burden_classicalSIR_V_cases <- as.data.frame(do.call(cbind, burden_classicalSIR_V_cases))

burden_classicalSIR_V_per <- as.data.frame(do.call(cbind, burden_classicalSIR_V_per))
#Đổi tên cột 
colnames(burden_classicalSIR_V_cases) <- paste0("Year", 1:ncol(burden_classicalSIR_V_cases))
colnames(burden_classicalSIR_V_per) <- paste0("PYear", 1:ncol(burden_classicalSIR_V_per))

```

**4b. Mô hình A**

```{r}

sir_model_A <-function(time,state,parameters){
  with(as.list(c(state,parameters)),{
    N=S+I+R+V1+V2
    F_A = beta*(I/N)*(S/N)
    F_V = rr*F_A
    w = 1/Dur
    gamma = 1/Dur2
    dS = -F_A*S + w*R + b*N +w*V2 - v*N
    dI = F_A*S + F_A*V1 + F_V*V2 - sigma*I
    dR = sigma*I - w*R
    dItotal = F_A*S + F_A*V1 + F_V*V2
    dV1 = v*N - F_A*V1 - gamma*V1
    dV2 = gamma*V1 - F_V*V2 - w*V2
    
    return(list(c(dS,dI,dR,dItotal,dV1,dV2)))
  }
  )
}


SIR_model_A = as.data.frame(ode(y = Initial_values,
                                func = sir_model_A,
                                parms = parameters,
                                times = time)) 


SIR_model_A$N = SIR_model_A$S+
                SIR_model_A$I+
                SIR_model_A$R+
                SIR_model_A$V1+
                SIR_model_A$V2
SIR_model_A$N_per = 100*SIR_model_A$N/SIR_model_A$N
SIR_model_A$S_per = 100*SIR_model_A$S/SIR_model_A$N
SIR_model_A$I_per = 100*SIR_model_A$I/SIR_model_A$N
SIR_model_A$R_per = 100*SIR_model_A$R/SIR_model_A$N
SIR_model_A$V1_per = 100*SIR_model_A$V1/SIR_model_A$N
SIR_model_A$V2_per = 100*SIR_model_A$V2/SIR_model_A$N
SIR_model_A$Itotal_per = 100*SIR_model_A$Itotal/SIR_model_A$N

plot(SIR_model_A$time,
     SIR_model_A$I_per,type = "l", col="red",
     ylab = "Tổng dân số(%)", ylim = c(0,100),
     xlab = "t", xlim=c(0,6000), lwd = 2)
lines(SIR_model_A$time, SIR_model_A$N_per)
lines(SIR_model_A$time, SIR_model_A$V2_per, col="darkorange", lwd = 2)
lines(SIR_model_A$time, SIR_model_A$R_per, col="darkgreen", lwd = 2)
lines(SIR_model_A$time, SIR_model_A$S_per,col="blue", lwd = 2)
title("Mô hình A", cex=0.8, adj=0)

# Thêm legend
legend("topright", legend=c("I", "V2", "S", "R"),
       col=c("red", "darkorange", "blue", "darkgreen"), lwd=2, cex=0.8)

#ggplot
long_data <- tidyr::pivot_longer(SIR_model_A, 
                                 cols = c(I_per, V2_per, S_per, R_per), 
                                 names_to = "variable", 
                                 values_to = "value")
long_data <- na.omit(long_data)


long_data <- long_data[long_data$value >= 0 & long_data$value <= 100 & long_data$time >= 0 & long_data$time <= 6000, ]

# Vẽ biểu đồ
ggplot(long_data, aes(x = time, y = value, color = variable)) +
  geom_line(size = 1) +
  geom_vline(xintercept = 1826, linetype = "dashed", size = 1) +  
  annotate("text", x = 1900, y = 80, label = "Thời điểm đạt trạng thái cân bằng t=1826", size = 3, hjust = 0) +
  scale_color_manual(values = c("I_per" = "red", "V2_per" = "darkorange", "S_per" = "blue", "R_per" = "darkgreen"),
                     labels = c("I(t)", "R(t)", "S(t)", "V2(t)")) + 
  labs(x = "t", y = "Tổng dân số (%)", title = "Mô hình A") +
  ylim(0, 100) +
  xlim(0, 6000) +
  theme_minimal() +
  theme(
    legend.position = c(0.8, 0.8),  
    legend.background = element_rect(fill = "white", color = "black", size = 0.5, linetype = "solid"),  # Tạo khung cho legend
    panel.background = element_rect(fill = "lightgray", color = NA),
    plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18)  
  ) +
  guides(color = guide_legend(title = NULL, override.aes = list(lwd = 2)))  


#Tạo vecto cho thời điểm cuối các năm 
years <- seq(365, 6935, by = 365)


# Tạo dữ liệu cho các năm (Year1, Year2,...)
burden_ASIR_V_cases <- list()
burden_ASIR_V_per <- list()
for (i in seq_along(years)) {
  start_idx <- ifelse(i == 1, 1, years[i-1] + 1)
  end_idx <- years[i]
  
  burden_ASIR_V_cases[[i]] <- SIR_model_A$Itotal[start_idx:end_idx] - ifelse(i == 1, 0, SIR_model_A$Itotal[years[i - 1]])
  burden_ASIR_V_per[[i]] <- SIR_model_A$Itotal_per[start_idx:end_idx] - ifelse(i == 1, 0, SIR_model_A$Itotal_per[years[i-1]])
}

#Chuyển từ list sang dataframe
burden_ASIR_V_cases <- as.data.frame(do.call(cbind, burden_ASIR_V_cases))

burden_ASIR_V_per <- as.data.frame(do.call(cbind, burden_ASIR_V_per))
#Đổi tên cột 
colnames(burden_ASIR_V_cases) <- paste0("Year", 1:ncol(burden_ASIR_V_cases))
colnames(burden_ASIR_V_per) <- paste0("PYear", 1:ncol(burden_ASIR_V_per))

```

**4c. Mô hình B**

```{r}

sir_model_B <-function(time,state,parameters){
  with(as.list(c(state,parameters)),{
    N=S+I+R+V1+V2
    F_B = beta*(I/N)*((N-R-V2)/N)
    F_V = rr*F_B
    w = 1/Dur
    gamma=1/Dur2
    dS = -F_B*S + w*R + b*N +w*V2 - v*N
    dI = F_B*S + F_B*V1 + F_V*V2 - sigma*I
    dR = sigma*I - w*R
    dItotal = F_B*S + F_B*V1 + F_V*V2
    dV1 = v*N - F_B*V1 - gamma*V1
    dV2 = gamma*V1 - F_V*V2 - w*V2
    
    return(list(c(dS,dI,dR,dItotal,dV1,dV2)))
  }
  )
}


SIR_model_B = as.data.frame(ode(y = Initial_values,
                                func = sir_model_B,
                                parms = parameters,
                                times = time)) 


SIR_model_B$N = SIR_model_B$S+
                SIR_model_B$I+
                SIR_model_B$R+
                SIR_model_B$V1+
                SIR_model_B$V2
SIR_model_B$N_per = 100*SIR_model_B$N/SIR_model_B$N
SIR_model_B$S_per = 100*SIR_model_B$S/SIR_model_B$N
SIR_model_B$I_per = 100*SIR_model_B$I/SIR_model_B$N
SIR_model_B$R_per = 100*SIR_model_B$R/SIR_model_B$N
SIR_model_B$V1_per = 100*SIR_model_B$V1/SIR_model_B$N
SIR_model_B$V2_per = 100*SIR_model_B$V2/SIR_model_B$N
SIR_model_B$Itotal_per = 100*SIR_model_B$Itotal/SIR_model_B$N

plot(SIR_model_B$time,
     SIR_model_B$I_per,type = "l", col="red",
     ylab = "Tổng dân số(%)", ylim = c(0,100),
     xlab = "t", xlim=c(0,5475), lwd = 3)
lines(SIR_model_B$time, SIR_model_B$N_per)
lines(SIR_model_B$time, SIR_model_B$V2_per, col="darkorange", lwd = 3)
lines(SIR_model_B$time, SIR_model_B$R_per, col="darkgreen", lwd = 3)
lines(SIR_model_B$time, SIR_model_B$S_per,col="blue", lwd = 3)
title("C) Mô hình B", cex=0.8, adj=0)

# Thêm legend
legend("topright", legend=c("I", "V2", "S", "R"),
       col=c("red", "darkorange", "blue", "darkgreen"), lwd=2, cex=0.8)

#ggplot
long_data <- tidyr::pivot_longer(SIR_model_B, 
                                 cols = c(I_per, V2_per, S_per, R_per), 
                                 names_to = "variable", 
                                 values_to = "value")
long_data <- na.omit(long_data)


long_data <- long_data[long_data$value >= 0 & long_data$value <= 100 & long_data$time >= 0 & long_data$time <= 6000, ]

# Vẽ biểu đồ
ggplot(long_data, aes(x = time, y = value, color = variable)) +
  geom_line(size = 1) +
  geom_vline(xintercept = 1826, linetype = "dashed", size = 1) +  
  annotate("text", x = 1900, y = 80, label = "Thời điểm đạt trạng thái cân bằng t=1826", size = 3, hjust = 0) +
  scale_color_manual(values = c("I_per" = "red", "V2_per" = "darkorange", "S_per" = "blue", "R_per" = "darkgreen"),
                     labels = c("I(t)", "R(t)", "S(t)", "V2(t)")) +  # Đặt tên cho các nhãn chú thích
  labs(x = "t", y = "Tổng dân số (%)", title = "Mô hình B") +
  ylim(0, 100) +
  xlim(0, 6000) +
  theme_minimal() +
  theme(
    legend.position = c(0.8, 0.8),  
    legend.background = element_rect(fill = "white", color = "black", size = 0.5, linetype = "solid"),  
    panel.background = element_rect(fill = "lightgray", color = NA),
    plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18) 
  ) +
  guides(color = guide_legend(title = NULL, override.aes = list(lwd = 2)))  

#Tạo vecto cho thời điểm cuối các năm 
years <- seq(365, 6935, by = 365)


# Tạo dữ liệu cho các năm (Year1, Year2,...)
burden_BSIR_V_cases <- list()
burden_BSIR_V_per <- list()
for (i in seq_along(years)) {
  start_idx <- ifelse(i == 1, 1, years[i-1] + 1)
  end_idx <- years[i]
  
  burden_BSIR_V_cases[[i]] <- SIR_model_B$Itotal[start_idx:end_idx] - ifelse(i == 1, 0, SIR_model_B$Itotal[years[i - 1]])
  burden_BSIR_V_per[[i]] <- SIR_model_B$Itotal_per[start_idx:end_idx] - ifelse(i == 1, 0, SIR_model_B$Itotal_per[years[i-1]])
}

#Chuyển từ list sang dataframe
burden_BSIR_V_cases <- as.data.frame(do.call(cbind, burden_BSIR_V_cases))

burden_BSIR_V_per <- as.data.frame(do.call(cbind, burden_BSIR_V_per))
#Đổi tên cột 
colnames(burden_BSIR_V_cases) <- paste0("Year", 1:ncol(burden_BSIR_V_cases))
colnames(burden_BSIR_V_per) <- paste0("PYear", 1:ncol(burden_BSIR_V_per))

```

**4d. So sánh với dữ liệu của CDC:**

```{r}
year = c(2010:2023)

USPopulation = c(311182845, 313876608, 316651321, 319375166, 322033964, 324607776, 327210198, 329791231, 332140037, 334319671, 335942003, 336997624, 338289857, 339996563)

data <- read.csv("D:/Document/Mô hình toán sinh thái/CDC_estimate.csv")

cdc_cases <- data$CDC_Cases
ul_cases <- data$UL_Cases
ll_cases <- data$LL_Cases


#Số ca bệnh tại thời điểm cuối của từng năm 
classical_SIR_cases = as.data.frame(t(print(burden_classicalSIR_V_cases[365,c(6:19)])))
classical_SIR_proportion = as.data.frame(t(print(burden_classicalSIR_V_per[365,c(6:19)])))


model_A_cases = as.data.frame(t(print(burden_ASIR_V_cases[365,c(6:19)])))
model_A_proportion = as.data.frame(t(print(burden_ASIR_V_per[365,c(6:19)])))


model_B_cases = as.data.frame(t(print(burden_BSIR_V_cases[365,c(6:19)])))
model_B_proportion = as.data.frame(t(print(burden_BSIR_V_per[365,c(6:19)])))



influenza = as.data.frame(cbind(year,USPopulation,cdc_cases,
                                ll_cases,ul_cases,
                                classical_SIR_cases$`365`,classical_SIR_proportion$`365`,
                                model_A_cases$`365`,model_A_proportion$`365`,
                                model_B_cases$`365`,model_B_proportion$`365`))

influenza$CDC_proprotion = 100*influenza$cdc_cases/influenza$USPopulation
influenza$ll_propotion = 100*influenza$ll_cases/influenza$USPopulation
influenza$ul_propotion = 100*influenza$ul_cases/influenza$USPopulation
#View(influenza)
#đổi tên biến 
names(influenza)[names(influenza) == "V6"] <- "Classical_SIR_cases"
names(influenza)[names(influenza) == "V7"] <- "Classical_SIR_proportion"
names(influenza)[names(influenza) == "V8"] <- "Model_A_cases"
names(influenza)[names(influenza) == "V9"] <- "Model_A_proportion"
names(influenza)[names(influenza) == "V10"] <- "Model_B_cases"
names(influenza)[names(influenza) == "V11"] <- "Model_B_proportion"

# Vẽ đồ thị so sánh kết quả mô phỏng của ba mô hình vs ước tính của CDC từ 2010 đến 2023 

library(dplyr)
library(tidyr)
library(ggplot2)


long_data <- influenza %>%
  pivot_longer(cols = c("CDC_proprotion", "ll_propotion", "ul_propotion", 
                         "Classical_SIR_proportion", "Model_A_proportion", "Model_B_proportion"),
               names_to = "model", values_to = "proportion")

# Đặt kiểu đường cho các mô hình
long_data$linetype <- ifelse(long_data$model == "ll_propotion", "dotted",
                              ifelse(long_data$model == "ul_propotion", "dotdash",
                                     "solid"))

# Đặt tên cho các mô hình trong legend
long_data$model <- recode(long_data$model,
                          CDC_proprotion = "CDC ước tính",
                          ll_propotion = "95% LL",
                          ul_propotion = "95% UL",
                          Classical_SIR_proportion = "SIR cổ điển",
                          Model_A_proportion = "Mô hình A",
                          Model_B_proportion = "Mô hình B")


ggplot(long_data, aes(x = year, y = proportion, color = model, linetype = model)) +
  geom_line(size = 0.8) +
  scale_color_manual(values = c("CDC ước tính" = "black", 
                                "95% LL" = "tomato", 
                                "95% UL" = "brown", 
                                "SIR cổ điển" = "red", 
                                "Mô hình A" = "green", 
                                "Mô hình B" = "blue")) +
  labs(x = "Năm", y = "Tổng dân số (%)", title = "Gánh nặng và dự đoán bệnh cúm mùa ở Hoa Kỳ") +
  xlim(2010, 2023) +
  ylim(0, 60) +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "lightgray", color = NA),
    plot.title = element_text(size = 20, face = "bold"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    axis.text.x = element_text(size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0.8, 0.7),
    legend.background = element_rect(fill = "white", color = "black"),
    legend.title = element_blank()
  ) +
  scale_linetype_manual(values = c("CDC ước tính" = "solid", 
                                   "95% LL" = "dashed", 
                                   "95% UL" = "dashed", 
                                   "SIR cổ điển" = "solid", 
                                   "Mô hình A" = "solid", 
                                   "Mô hình B" = "solid")) +
  guides(
    color = guide_legend(
      override.aes = list(
        linetype = c("dashed", "dashed", "solid", "solid", "solid", "solid"))
    ),
    linetype = "none"
  ) +
  scale_x_continuous(breaks = seq(2010, 2023, by = 1))


```
